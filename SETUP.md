# Requirements

* A web server such as nginx or apache2 with rewriteEngine module enabled. Note that we had problems configuring Nginx so you might need to debug the autogenerated config file.
* PHP >= 8.0
* Mysql or mariadb.
* Composer (php package manager). [Install Composer](https://getcomposer.org/download)
* A web browser (unless you want to configure ini files by hand)
* A client application which supports the credit commons API. eg the [developer client](https://gitlab.com/credit-commons/cc-dev-client)

# Ways of running cc-node.
There are different ways to run cc-node, as a stand alone application with a REST interface, or incorporated into a larger application.  Similarly the two subservices can be standalone REST services, or can be incorporated by specifying a class name in the node.ini file. This SETUP file assumes you want to run cc-node as part of another application. If you want to run a standalone node, see the setup instructions in the cc-server package.

# Installation procedure for incorporating into an app

  * Navigate to the directory above where you want to serve from e.g. /var/www/ and run the following command replacing MY_CC_SERVER_DIR with the directory name.
  * $ composer create-project --stability dev credit-commons/cc-node --repository '{"type": "gitlab","url": "git@gitlab.com:credit-commons/cc-node"}' MY_CC_SERVER_DIR
  * Retrieve credit-commons/cc-node which includes cc-php-lib as a dependency.
  * Navigate to the current directory and do ``composer install --no-dev``
  * Set up a database by running the queries in install.sql
  * Determine what accountStore to use. The default node.ini points to the example accountStore included as a class, not as a REST service, but you will need to make a class that exposes the users objects of your main application.
  * If you want transaction fees, you'll need to write a business logic class.
  * Edit node.ini entering those class names, db credentials, and other settings.
  * (optional) Modify AccountStore/.htaccess and BlogicService/.htaccess config/.htaccess to restrict access to your IP address. @todo couldn't all this be done from one .htaccess file? @todo how would this be done with nginx?

# Using cc-node as a code library for your app.
  To access classes in all credit commons namespaces your app should require_once __DIR__ . '/vendor/autoload.php';
  - \CCNode\functions
  - \CCNode\Node
  - \CCNode\Transaction\Transaction
  - \CreditCommons\Exceptions
  - \CreditCommons\Workflow
  - and many more.
  
### Writing your own account store.
  * Whenever cc-node receives a request it will check with the main platforms that the cc-user header contains a valid username and cc-auth header the password for that user. When cc-node is instructed to log a transaction, it will check with the main app that the parties to that transaction exist.
  * The accountStore can either be included as a class in your application or it can be set up as a REST service.
  * An example rest service is in an adjacent respository cc-accountstore-server, including the OpenAPI 3.0 definition
  * Otherwise make a new class that implements [AccountstoreInterface](https://gitlab.com/credit-commons/cc-php-lib/-/blob/master/src/AccountStoreInterface.php
The business logic, is optional but works in a similar way. You can set up a microservice which implements the one method API, example is [cc-blogic-server](blah)
  
### Writing your own business logic unit.
  * every node accross which a transaction passes has an opportunity to add entries to it.
  * in the node.ini file is specified the class name or REST Url of the business logic unit.
  * an example blogic service is provided in the https://gitlab.com/credit-commons/cc-blogic-server
  * An example blogic class is provide in vendor/credit-commons/cc-php-lib/examples/BlogicDemo

## Doing development

  * Run composer as above but without the ``--no-dev`` flag. This will include the packages needed for testing.
  * The OpenApi spec is at vendor/credit-commons/cc-php-lib/docs/credit-commons-openapi-3.0.yml
  * unittest compares inputs and outputs against the (local) Openapi spec. To run the battery of tests, from the node root ,do ``vendor/bin/phpunit tests/SingleNodeTest.php``

# Minimal settings for virtualhosts
## Apache
``<VirtualHost *:80>
  ServerName myccnode
  DocumentRoot /var/www/my-cc-node
</VirtualHost>

Each of these documentRoots must have the .htaccess file provided, as must myccnode/config
## nginx 
  todo

### Setting/refreshing the database
Basically run the sql in install.sql
This can be done via the command line. search "run sql queries from text file."

    mysqldump -uUSER -pPASS install.sql > DBNAME